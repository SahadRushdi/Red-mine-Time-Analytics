<%= render 'time_analytics/includes' %>

<style>
  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
    flex-wrap: wrap;
    gap: 10px;
  }
  .dashboard-header h2 {
    margin: 0;
    flex-shrink: 0;
  }
  .context-pills-bar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    flex-grow: 1;
    justify-content: flex-end;
  }
  .context-pill {
    display: flex;
    align-items: center;
    background-color: #e7e7e7;
    border-radius: 12px;
    padding: 4px 10px;
    font-size: 0.9em;
    white-space: nowrap;
    border: 1px solid #dcdcdc;
  }
  .context-pill .pill-label {
    color: #555;
    margin-right: 6px;
    font-weight: bold;
  }
  .context-pill .pill-value {
    color: #111;
  }
  .context-pill .remove-pill {
    margin-left: 8px;
    color: #777;
    text-decoration: none;
    font-weight: bold;
    font-size: 1.2em;
    line-height: 1;
    padding: 0 2px;
  }
  .context-pill .remove-pill:hover {
    color: #d00;
  }
  
  /* Responsive styles for mobile */
  @media (max-width: 920px) {
    .dashboard-header {
      flex-direction: column;
      align-items: flex-start;
    }
    .context-pills-bar {
      justify-content: flex-start;
      width: 100%;
    }
  }
  
  @media (max-width: 600px) {
    .dashboard-header h2 {
      font-size: 1.3em;
    }
    .context-pill {
      font-size: 0.85em;
      padding: 3px 8px;
    }
  }
  
  /* Team-specific table styling */
  .team-time-overview-table {
    width: 100%;
    border-collapse: collapse;
  }
  .team-time-overview-table th {
    background-color: #f5f5f5;
    padding: 8px;
    text-align: left;
    border-bottom: 2px solid #ddd;
  }
  .team-time-overview-table td {
    padding: 8px;
    border-bottom: 1px solid #eee;
  }
  .team-time-overview-table .date-column {
    width: 130px;
    min-width: 130px;
    white-space: nowrap;
  }
  .team-time-overview-table .member-count-column {
    text-align: center;
    width: 100px;
    padding-left: 0px;
    padding-right: -6px;
  }
  .team-time-overview-table .hours-column {
    text-align: right;
    width: 120px;
  }
  
  /* Member link styling */
  .member-link {
    color: #169;
    text-decoration: none;
    font-weight: normal;
    transition: color 0.2s ease;
  }
  .member-link:hover {
    color: #007cba;
    text-decoration: underline;
  }
  .member-link:visited {
    color: #169;
  }
</style>

<script type="text/javascript">
  function toggle_filters(element) {
    var filters = $('#filters');
    if (filters.css('display') == 'none') {
      filters.slideDown();
      $(element).removeClass('collapsed');
    } else {
      filters.slideUp();
      $(element).addClass('collapsed');
    }
  }
</script>

<div class="contextual">
  <%= link_to l(:label_export_csv), team_analytics_export_csv_path(params.permit(:filter, :from, :to, :grouping, :search, :chart_type, :per_page, :page, :view_mode, :team_id)), 
      method: :post, class: 'icon icon-download' %>
</div>

<div class="dashboard-header">
  <h2><%= l(:label_team_dashboard) || "Team Dashboard" %> - <%= @selected_team&.name %></h2>
  <div class="context-pills-bar">
    <div class="context-pill">
      <span class="pill-label">View:</span>
      <span class="pill-value"><%= l("label_#{@view_mode}") rescue @view_mode.capitalize %></span>
    </div>

    <div class="context-pill">
      <span class="pill-label">Period:</span>
      <span class="pill-value"><%= (params[:filter] || 'Last 7 days').humanize %></span>
    </div>

    <div class="context-pill">
      <span class="pill-label">Grouped By:</span>
      <span class="pill-value"><%= grouping_label(@grouping) %></span>
    </div>
    
    <% if params[:search].present? %>
      <div class="context-pill">
        <span class="pill-label">Search:</span>
        <span class="pill-value">'<%= params[:search] %>'</span>
        <%= link_to '×', url_for(params.to_unsafe_h.except(:search)), class: 'remove-pill', title: 'Remove Search Filter' %>
      </div>
    <% end %>
  </div>
</div>

<div class="filters-toggle-wrapper">
  <fieldset>
    <legend onclick="toggle_filters(this);" class="collapsible collapsed">
      <%= l(:label_filter_plural) %>
    </legend>
  </fieldset>
</div>

<div id="filters" class="collapsible" style="display:none;">
  <%= render(partial: 'team_analytics/filters_panel') %>
  <%= render(partial: 'team_analytics/view_togglers') %>
</div>

<%# Dashboard Analytics Section - Summary, Time Overview, and Visualization %>
<div class="analytics-section">
  <%# Team Statistics Summary Box (Left Side) %>
  <div class="box stats-summary">
    <h3><%= l(:label_summary) %></h3>
    <div class="summary-grid">
      <div class="summary-item">
        <div class="summary-value"><%= format_hours(@total_hours) %></div>
        <div class="summary-label"><%= l(:label_total_hours) || 'TOTAL HOURS' %></div>
      </div>
      <div class="summary-item">
        <div class="summary-value"><%= format_hours(@max_period_hours) %></div>
        <div class="summary-label"><%= max_label_for_grouping(@grouping) %></div>
      </div>
      <div class="summary-item">
        <div class="summary-value"><%= format_hours(@min_period_hours) %></div>
        <div class="summary-label"><%= min_label_for_grouping(@grouping) %></div>
      </div>
    </div>
  </div>

  <%# Time Overview Box (Middle) - Shows Date, Team Member Count, Hours %>
  <% if (@view_mode == 'time_entries' || @view_mode == 'activity' || @view_mode == 'project' || @view_mode == 'members') && @time_overview_data&.any? %>
    <div class="box time-overview-box">
      <h3><%= l(:label_time_overview) %></h3>
      
      <%# All views (Time, Activity, Project, Members) use the same 3-column table structure %>
      <table class="team-time-overview-table">
        <thead>
          <tr>
            <th class="date-column"><%= @grouping == 'daily' ? l(:label_date) : l("label_#{@grouping}") %></th>
            <th class="member-count-column">Team Size</th>
            <th class="hours-column"><%= l(:label_hours) %></th>
          </tr>
        </thead>
        <tbody>
          <% @time_overview_data.slice(@offset, @limit).each do |entry| %>
            <tr>
              <td class="date-column"><%= entry.period %></td>
              <td class="member-count-column"><%= entry.member_count %></td>
              <td class="hours-column"><%= format_hours(entry.hours) %></td>
            </tr>
          <% end %>
        </tbody>
        <tfoot>
          <tr class="total-row">
            <td class="date-column"><strong><%= l(:label_total) %></strong></td>
            <td class="member-count-column"></td>
            <td class="hours-column"><strong><%= format_hours(@total_hours) %></strong></td>
          </tr>
        </tfoot>
      </table>
      
      <%# Pagination %>
      <div class="pagination-wrapper">
        <% current_page = params[:page].to_i > 0 ? params[:page].to_i : 1 %>
        <% permitted_params = params.permit(:filter, :from, :to, :grouping, :search, :chart_type, :per_page, :view_mode, :team_id) %>
        <%= pagination_links(current_page, @total_pages, permitted_params).html_safe %>
        
        <div class="pagination-info">
          <%= l(:text_pagination_info, 
              from: (@offset + 1), 
              to: [@offset + @limit, @entry_count].min, 
              total: @entry_count) %>
        </div>
      </div>
    </div>
  <% end %>

  <%# Visualization Section (Right Side) %>
  <div class="box visualization-section">
    <h3 style="display: flex; justify-content: flex-end;">
      <div class="visualization-controls">
        <%# Chart Type Dropdown %>
        <style>
          .visualization-controls .custom-chart-dropdown {
            position: relative;
            display: inline-block;
          }
          .visualization-controls .dropdown-toggle {
            background-color: #f5f5f5;
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
            min-width: 100px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            font-family: inherit;
            color: #333;
            height: 30px;
          }
          .visualization-controls .dropdown-toggle:hover {
            background-color: #eee;
            border-color: #999;
          }
          .visualization-controls .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 3px;
            list-style: none;
            padding: 5px 0;
            margin: 2px 0 0;
            min-width: 120px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
          }
          .visualization-controls .dropdown-menu.show {
            display: block;
          }
          .visualization-controls .dropdown-menu li a {
            display: block;
            padding: 8px 12px;
            color: #333;
            text-decoration: none;
            font-size: 13px;
            font-family: inherit;
            white-space: nowrap;
          }
          .visualization-controls .dropdown-menu li a:hover {
            background-color: #f0f0f0;
          }
          .visualization-controls .arrow-down {
            border: solid #555;
            border-width: 0 1.5px 1.5px 0;
            display: inline-block;
            padding: 2.5px;
            transform: rotate(45deg);
            margin-left: 8px;
          }
        </style>

        <% if @view_mode == 'time_entries' || @view_mode == 'activity' || @view_mode == 'project' %>
          <div class="custom-chart-dropdown">
            <button type="button" class="dropdown-toggle" id="team-chart-toggle">
              <% default_chart_type = (@view_mode == 'activity' || @view_mode == 'project') ? 'pie' : 'line' %>
              <span id="team-chart-label"><%= (params[:chart_type] || default_chart_type).capitalize %></span>
              <i class="arrow-down"></i>
            </button>
            <ul class="dropdown-menu" id="team-chart-menu">
              <li><a href="#" data-value="line">Line</a></li>
              <li><a href="#" data-value="bar">Bar</a></li>
              <li><a href="#" data-value="pie">Pie</a></li>
            </ul>
          </div>
        <% end %>
      </div>
    </h3>
    
    <% if (@view_mode == 'time_entries' || @view_mode == 'activity' || @view_mode == 'project' || @view_mode == 'members') && @chart_data.present? && @entry_count > 0 %>
      <div id="chart-container" style="display: block;">
        <div class="chart-wrapper">
          <canvas id="time-chart" class="chart" 
                  data-chart='<%= @chart_data %>' 
                  data-grouping-label="<%= grouping_label(@grouping) %>"></canvas>
        </div>
      </div>
    <% elsif @view_mode == 'time_entries' || @view_mode == 'activity' || @view_mode == 'project' || @view_mode == 'members' %>
      <div class="chart-container" style="display: flex; align-items: center; justify-content: center; min-height: 300px; background: #f9f9f9; border: 1px dashed #ccc; border-radius: 5px;">
        <div style="text-align: center; padding: 40px; color: #666;">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 15px; opacity: 0.5;">
            <line x1="18" y1="20" x2="18" y2="10"></line>
            <line x1="12" y1="20" x2="12" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="14"></line>
          </svg>
          <p style="margin: 0; font-size: 1.1em; font-weight: 500;">No Data Available</p>
          <p style="margin: 10px 0 0 0; font-size: 0.9em;">
            <% if @team_size == 0 %>
              No active team members found for this period
            <% elsif @time_entries.empty? %>
              No time entries found for the selected period and team
            <% else %>
              Adjust filters to view chart
            <% end %>
          </p>
        </div>
      </div>
    <% else %>
      <div class="chart-container" style="display: flex; align-items: center; justify-content: center; min-height: 300px; background: #f9f9f9; border: 1px dashed #ccc; border-radius: 5px;">
        <div style="text-align: center; padding: 40px; color: #666;">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 15px; opacity: 0.5;">
            <line x1="18" y1="20" x2="18" y2="10"></line>
            <line x1="12" y1="20" x2="12" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="14"></line>
          </svg>
          <p style="margin: 0; font-size: 1.1em; font-weight: 500;">Chart Visualization</p>
          <p style="margin: 10px 0 0 0; font-size: 0.9em;">Chart will be available for this view soon</p>
        </div>
      </div>
    <% end %>
  </div>
</div>

<%# Additional View-Specific Content %>
<% if @view_mode == 'activity' %>
  <%# Activity Analysis Tables - Show pivot table for Activity × Time Period %>
  <% if @activities&.any? %>
    <div class="box">
      <h3>
        Time by Activity
        <div class="view-toggle-controls">
          <button type="button" id="toggle-activity-view-btn" class="button button-base button-primary" onclick="toggleActivityView()">
            <span id="view-toggle-text">Show Summary View</span>
          </button>
        </div>
        <div class="table-controls">
          <%= form_tag team_analytics_path, method: :get, local: true, 
              class: 'pagination-form' do %>
            <%= hidden_field_tag :filter, params[:filter] %>
            <%= hidden_field_tag :from, params[:from] %>
            <%= hidden_field_tag :to, params[:to] %>
            <%= hidden_field_tag :grouping, params[:grouping] %>
            <%= hidden_field_tag :search, params[:search] %>
            <%= hidden_field_tag :chart_type, params[:chart_type] %>
            <%= hidden_field_tag :view_mode, @view_mode %>
            <%= hidden_field_tag :team_id, params[:team_id] %>
            <%= hidden_field_tag :activity_view_state, @activity_view_state, id: 'activity_view_state_field' %>
            <%= label_tag :per_page, l(:label_per_page) %>
            <%= select_tag :per_page, options_for_select(per_page_options, @limit),
                onchange: 'this.form.submit()' %>
          <% end %>
        </div>
      </h3>

      <%# Detailed View: Pivot Table (Time Period × Activity matrix) - Default %>
      <div id="team-activity-detailed-view" class="pivot-table-wrapper">
        <table class="list pivot-table">
          <thead>
            <tr>
              <th class="period-header"><%= @grouping == 'daily' ? l(:label_date) : l("label_#{@grouping}") %></th>
              <% @activities.each do |activity| %>
                <th class="activity-header"><%= activity %></th>
              <% end %>
              <th class="total-header">Grand Total</th>
            </tr>
          </thead>
          <tbody>
            <% @paginated_periods.each_with_index do |period_display, index| %>
              <% period_key = @activity_pivot_data[:raw_periods][(@offset + index)] %>
              <tr>
                <td class="period-cell"><%= period_display %></td>
                <% @activities.each do |activity| %>
                  <td class="hours-cell">
                    <% hours = @matrix_data[period_key][activity] || 0 %>
                    <%= hours > 0 ? format_hours(hours) : '' %>
                  </td>
                <% end %>
                <td class="total-cell">
                  <%= format_hours(@period_totals[period_key] || 0) %>
                </td>
              </tr>
            <% end %>
          </tbody>
          <tfoot>
            <tr class="total-row">
              <td class="period-cell"><strong><%= @grouping == 'daily' ? 'Activity Total' : 'Grand Total' %></strong></td>
              <% @activities.each do |activity| %>
                <td class="total-cell">
                  <strong><%= format_hours(@activity_totals[activity] || 0) %></strong>
                </td>
              <% end %>
              <td class="grand-total-cell">
                <strong><%= format_hours(@grand_total || 0) %></strong>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
      
      <%# Summary View: Simple Activity Table (Hidden by default) %>
      <div id="team-activity-summary-view" style="display: none;">
        <table class="list time-entries-grouped-table summary-with-bars">
          <thead>
            <tr>
              <th>Activity</th>
              <th class="hours-column sortable" onclick="sortTable(this, 1, 'team-activity-summary-view')" title="Click to sort">
                Total Hours <span class="sort-indicator">⇅</span>
              </th>
              <th class="bar-column">Distribution</th>
            </tr>
          </thead>
          <tbody>
            <% @activities.each do |activity| %>
              <% hours = @activity_totals[activity] || 0 %>
              <% percentage = @grand_total > 0 ? (hours / @grand_total * 100) : 0 %>
              <tr>
                <td><%= activity %></td>
                <td class="hours-column" data-value="<%= hours %>"><%= format_hours(hours) %></td>
                <td class="bar-column">
                  <div class="bar-container">
                    <div class="bar-fill" style="width: <%= percentage %>%"></div>
                    <span class="bar-label"><%= number_with_precision(percentage, precision: 1) %>%</span>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
          <tfoot>
            <tr class="total-row">
              <td><strong><%= l(:label_total) %></strong></td>
              <td class="hours-column"><strong><%= format_hours(@grand_total || 0) %></strong></td>
              <td class="bar-column"></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <%# Pagination for Activity view %>
      <div class="pagination-wrapper">
        <% current_page = params[:page].to_i > 0 ? params[:page].to_i : 1 %>
        <% permitted_params = params.permit(:filter, :from, :to, :grouping, :search, :chart_type, :per_page, :view_mode, :team_id, :activity_view_state) %>
        <%= pagination_links(current_page, @total_pages, permitted_params).html_safe %>
        
        <div class="pagination-info" id="pagination-info-text" 
             data-detailed-text="<%= l(:text_pagination_info, from: (@offset + 1), to: [@offset + @limit, @entry_count].min, total: @entry_count) %>"
             data-activity-count="<%= @activities&.count || 0 %>"
             data-view-mode="<%= @view_mode %>">
          <%= l(:text_pagination_info, 
              from: (@offset + 1), 
              to: [@offset + @limit, @entry_count].min, 
              total: @entry_count) %>
        </div>
      </div>
    </div>
  <% else %>
    <div class="box" style="margin-top: 20px;">
      <p class="nodata"><%= l(:label_no_data) %></p>
    </div>
  <% end %>
<% elsif @view_mode == 'project' %>
  <%# Project Analysis Tables - Show pivot table for Project × Time Period %>
  <% if @projects&.any? %>
    <div class="box">
      <h3>
        Time by Project
        <div class="view-toggle-controls">
          <button type="button" id="toggle-project-view-btn" class="button button-base button-primary" onclick="toggleProjectView()">
            <span id="project-view-toggle-text">Show Summary View</span>
          </button>
        </div>
        <div class="table-controls">
          <%= form_tag team_analytics_path, method: :get, local: true, 
              class: 'pagination-form' do %>
            <%= hidden_field_tag :filter, params[:filter] %>
            <%= hidden_field_tag :from, params[:from] %>
            <%= hidden_field_tag :to, params[:to] %>
            <%= hidden_field_tag :grouping, params[:grouping] %>
            <%= hidden_field_tag :search, params[:search] %>
            <%= hidden_field_tag :chart_type, params[:chart_type] %>
            <%= hidden_field_tag :view_mode, @view_mode %>
            <%= hidden_field_tag :team_id, params[:team_id] %>
            <%= hidden_field_tag :project_view_state, @project_view_state, id: 'project_view_state_field' %>
            <%= label_tag :per_page, l(:label_per_page) %>
            <%= select_tag :per_page, options_for_select(per_page_options, @limit),
                onchange: 'this.form.submit()' %>
          <% end %>
        </div>
      </h3>

      <%# Detailed View: Pivot Table (Time Period × Project matrix) - Default %>
      <div id="team-project-detailed-view" class="pivot-table-wrapper">
        <table class="list pivot-table">
          <thead>
            <tr>
              <th class="period-header"><%= @grouping == 'daily' ? l(:label_date) : l("label_#{@grouping}") %></th>
              <% @projects.each do |project| %>
                <th class="project-header"><%= project %></th>
              <% end %>
              <th class="total-header">Grand Total</th>
            </tr>
          </thead>
          <tbody>
            <% @paginated_periods.each_with_index do |period_display, index| %>
              <% period_key = @project_pivot_data[:raw_periods][(@offset + index)] %>
              <tr>
                <td class="period-cell"><%= period_display %></td>
                <% @projects.each do |project| %>
                  <td class="hours-cell">
                    <% hours = @matrix_data[period_key][project] || 0 %>
                    <%= hours > 0 ? format_hours(hours) : '' %>
                  </td>
                <% end %>
                <td class="total-cell">
                  <%= format_hours(@period_totals[period_key] || 0) %>
                </td>
              </tr>
            <% end %>
          </tbody>
          <tfoot>
            <tr class="total-row">
              <td class="period-cell"><strong><%= @grouping == 'daily' ? 'Project Total' : 'Grand Total' %></strong></td>
              <% @projects.each do |project| %>
                <td class="total-cell">
                  <strong><%= format_hours(@project_totals[project] || 0) %></strong>
                </td>
              <% end %>
              <td class="grand-total-cell">
                <strong><%= format_hours(@grand_total || 0) %></strong>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
      
      <%# Summary View: Simple Project Table (Hidden by default) %>
      <div id="team-project-summary-view" style="display: none;">
        <table class="list time-entries-grouped-table summary-with-bars">
          <thead>
            <tr>
              <th>Project</th>
              <th class="hours-column sortable" onclick="sortTable(this, 1, 'team-project-summary-view')" title="Click to sort">
                Total Hours <span class="sort-indicator">⇅</span>
              </th>
              <th class="bar-column">Distribution</th>
            </tr>
          </thead>
          <tbody>
            <% @projects.each do |project| %>
              <% hours = @project_totals[project] || 0 %>
              <% percentage = @grand_total > 0 ? (hours / @grand_total * 100) : 0 %>
              <tr>
                <td><%= project %></td>
                <td class="hours-column" data-value="<%= hours %>"><%= format_hours(hours) %></td>
                <td class="bar-column">
                  <div class="bar-container">
                    <div class="bar-fill" style="width: <%= percentage %>%"></div>
                    <span class="bar-label"><%= number_with_precision(percentage, precision: 1) %>%</span>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
          <tfoot>
            <tr class="total-row">
              <td><strong><%= l(:label_total) %></strong></td>
              <td class="hours-column"><strong><%= format_hours(@grand_total || 0) %></strong></td>
              <td class="bar-column"></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <%# Pagination for Project view %>
      <div class="pagination-wrapper">
        <% current_page = params[:page].to_i > 0 ? params[:page].to_i : 1 %>
        <% permitted_params = params.permit(:filter, :from, :to, :grouping, :search, :chart_type, :per_page, :view_mode, :team_id, :project_view_state) %>
        <%= pagination_links(current_page, @total_pages, permitted_params).html_safe %>
        
        <div class="pagination-info" id="pagination-info-text" 
             data-detailed-text="<%= l(:text_pagination_info, from: (@offset + 1), to: [@offset + @limit, @entry_count].min, total: @entry_count) %>"
             data-project-count="<%= @projects&.count || 0 %>"
             data-view-mode="<%= @view_mode %>">
          <%= l(:text_pagination_info, 
              from: (@offset + 1), 
              to: [@offset + @limit, @entry_count].min, 
              total: @entry_count) %>
        </div>
      </div>
    </div>
  <% else %>
    <div class="box" style="margin-top: 20px;">
      <p class="nodata"><%= l(:label_no_data) %></p>
    </div>
  <% end %>
<% elsif @view_mode == 'members' %>
  <%# Member Analysis Tables - Show pivot table for Member × Time Period %>
  <% if @members&.any? %>
    <div class="box">
      <h3>
        Time by Member
        <div class="view-toggle-controls">
          <button type="button" id="toggle-member-view-btn" class="button button-base button-primary" onclick="toggleMemberView()">
            <span id="member-view-toggle-text">Show Summary View</span>
          </button>
        </div>
        <div class="table-controls">
          <%= form_tag team_analytics_path, method: :get, local: true, 
              class: 'pagination-form' do %>
            <%= hidden_field_tag :filter, params[:filter] %>
            <%= hidden_field_tag :from, params[:from] %>
            <%= hidden_field_tag :to, params[:to] %>
            <%= hidden_field_tag :grouping, params[:grouping] %>
            <%= hidden_field_tag :search, params[:search] %>
            <%= hidden_field_tag :chart_type, params[:chart_type] %>
            <%= hidden_field_tag :view_mode, @view_mode %>
            <%= hidden_field_tag :team_id, params[:team_id] %>
            <%= hidden_field_tag :member_view_state, @member_view_state, id: 'member_view_state_field' %>
            <%= label_tag :per_page, l(:label_per_page) %>
            <%= select_tag :per_page, options_for_select(per_page_options, @limit),
                onchange: 'this.form.submit()' %>
          <% end %>
        </div>
      </h3>

      <%# Detailed View: Pivot Table (Time Period × Member matrix) - Default %>
      <div id="team-member-detailed-view" class="pivot-table-wrapper">
        <table class="list pivot-table">
          <thead>
            <tr>
              <th class="period-header"><%= @grouping == 'daily' ? l(:label_date) : l("label_#{@grouping}") %></th>
              <% @members.each do |member| %>
                <th class="member-header">
                  <%= link_to member, my_time_path(user_id: @member_user_ids[member]), 
                      class: 'member-link', 
                      title: "View #{member}'s individual dashboard" %>
                </th>
              <% end %>
              <th class="total-header">Grand Total</th>
            </tr>
          </thead>
          <tbody>
            <% @paginated_periods.each_with_index do |period_display, index| %>
              <% period_key = @member_pivot_data[:raw_periods][(@offset + index)] %>
              <tr>
                <td class="period-cell"><%= period_display %></td>
                <% @members.each do |member| %>
                  <td class="hours-cell">
                    <% hours = @matrix_data[period_key][member] || 0 %>
                    <%= hours > 0 ? format_hours(hours) : '' %>
                  </td>
                <% end %>
                <td class="total-cell">
                  <%= format_hours(@period_totals[period_key] || 0) %>
                </td>
              </tr>
            <% end %>
          </tbody>
          <tfoot>
            <tr class="total-row">
              <td class="period-cell"><strong><%= @grouping == 'daily' ? 'Member Total' : 'Grand Total' %></strong></td>
              <% @members.each do |member| %>
                <td class="total-cell">
                  <strong><%= format_hours(@member_totals[member] || 0) %></strong>
                </td>
              <% end %>
              <td class="grand-total-cell">
                <strong><%= format_hours(@grand_total || 0) %></strong>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
      
      <%# Summary View: Simple Member Table (Hidden by default) %>
      <div id="team-member-summary-view" style="display: none;">
        <table class="list time-entries-grouped-table summary-with-bars">
          <thead>
            <tr>
              <th>Member</th>
              <th class="hours-column sortable" onclick="sortTable(this, 1, 'team-member-summary-view')" title="Click to sort">
                Total Hours <span class="sort-indicator">⇅</span>
              </th>
              <th class="bar-column">Distribution</th>
            </tr>
          </thead>
          <tbody>
            <% @members.each do |member| %>
              <% hours = @member_totals[member] || 0 %>
              <% percentage = @grand_total > 0 ? (hours / @grand_total * 100) : 0 %>
              <tr>
                <td>
                  <%= link_to member, my_time_path(user_id: @member_user_ids[member]), 
                      class: 'member-link', 
                      title: "View #{member}'s individual dashboard" %>
                </td>
                <td class="hours-column" data-value="<%= hours %>"><%= format_hours(hours) %></td>
                <td class="bar-column">
                  <div class="bar-container">
                    <div class="bar-fill" style="width: <%= percentage %>%"></div>
                    <span class="bar-label"><%= number_with_precision(percentage, precision: 1) %>%</span>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
          <tfoot>
            <tr class="total-row">
              <td><strong><%= l(:label_total) %></strong></td>
              <td class="hours-column"><strong><%= format_hours(@grand_total || 0) %></strong></td>
              <td class="bar-column"></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <%# Pagination for Member view %>
      <div class="pagination-wrapper">
        <% current_page = params[:page].to_i > 0 ? params[:page].to_i : 1 %>
        <% permitted_params = params.permit(:filter, :from, :to, :grouping, :search, :chart_type, :per_page, :view_mode, :team_id, :member_view_state) %>
        <%= pagination_links(current_page, @total_pages, permitted_params).html_safe %>
        
        <div class="pagination-info" id="pagination-info-text" 
             data-detailed-text="<%= l(:text_pagination_info, from: (@offset + 1), to: [@offset + @limit, @entry_count].min, total: @entry_count) %>"
             data-member-count="<%= @members&.count || 0 %>"
             data-view-mode="<%= @view_mode %>">
          <%= l(:text_pagination_info, 
              from: (@offset + 1), 
              to: [@offset + @limit, @entry_count].min, 
              total: @entry_count) %>
        </div>
      </div>
    </div>
  <% else %>
    <div class="box" style="margin-top: 20px;">
      <p class="nodata"><%= l(:label_no_data) %></p>
    </div>
  <% end %>
<% end %>

<script>
  // Auto-submit team selector on change
  document.addEventListener('DOMContentLoaded', function() {
    const teamSelect = document.getElementById('team_id');
    if (teamSelect) {
      teamSelect.addEventListener('change', function() {
        this.form.submit();
      });
    }
    
    // Chart type dropdown functionality for Team Analytics
    const toggleBtn = document.getElementById('team-chart-toggle');
    const menu = document.getElementById('team-chart-menu');
    const label = document.getElementById('team-chart-label');
    
    if (toggleBtn && menu) {
      // Toggle menu visibility
      toggleBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        menu.classList.toggle('show');
      });
      
      // Handle item selection
      menu.addEventListener('click', function(e) {
        if (e.target.tagName === 'A') {
          e.preventDefault();
          const chartType = e.target.getAttribute('data-value');
          const text = e.target.textContent;
          
          // Update label
          if(label) {
            label.textContent = text;
          }
          
          // Update hidden field and submit form
          const hiddenField = document.getElementById('chart_type_hidden');
          if (hiddenField) {
            hiddenField.value = chartType;
          }
          
          menu.classList.remove('show');
          
          // Submit the form to reload with new chart type
          const form = document.getElementById('team-analytics-form');
          if (form) {
            form.submit();
          }
        }
      });
      
      // Hide menu if clicking outside
      document.addEventListener('click', function(e) {
        if (!toggleBtn.contains(e.target)) {
          menu.classList.remove('show');
        }
      });
    }

    // Initialize chart
    initChart();
    
    // Restore activity view state
    restoreActivityViewState();
    
    // Restore project view state
    restoreProjectViewState();
    
    // Restore member view state
    restoreMemberViewState();
  });

  // Chart initialization
  var teamChart = null;

  function initChart() {
    var chartElement = document.getElementById('time-chart');
    if (!chartElement) {
      console.log('Chart element not found');
      return;
    }

    // Prevent multiple chart creation
    if (teamChart) {
      teamChart.destroy();
      teamChart = null;
    }

    try {
      var chartData = chartElement.getAttribute('data-chart');
      if (!chartData || chartData === 'null' || chartData === '') {
        console.log('No chart data available');
        return;
      }

      var config = JSON.parse(chartData);
      
      // Ensure responsive configuration
      if (!config.options) {
        config.options = {};
      }
      config.options.responsive = true;
      config.options.maintainAspectRatio = false;

      // Add custom tooltip callback for weekly grouping (bar and line charts)
      if ((config.type === 'bar' || config.type === 'line') && config.data.datasets[0].tooltipLabels) {
        if (!config.options.plugins) config.options.plugins = {};
        if (!config.options.plugins.tooltip) config.options.plugins.tooltip = {};
        if (!config.options.plugins.tooltip.callbacks) config.options.plugins.tooltip.callbacks = {};
        
        config.options.plugins.tooltip.callbacks.title = function(context) {
          var index = context[0].dataIndex;
          var tooltipLabels = context[0].dataset.tooltipLabels;
          return tooltipLabels ? tooltipLabels[index] : context[0].label;
        };
      }

      // Dynamically add tooltip callbacks on the client-side for pie charts
      if (config.type === 'pie' && config.options.plugins && config.options.plugins.tooltip) {
        config.options.plugins.tooltip.callbacks = {
          title: function(context) {
            // Check if custom tooltip labels exist for detailed weekly format
            var index = context[0].dataIndex;
            var tooltipLabels = context[0].dataset.tooltipLabels;
            if (tooltipLabels && tooltipLabels[index]) {
              return tooltipLabels[index];
            }
            // Otherwise, extract the label part before percentage
            var label = context[0].label || '';
            return label.split(' (')[0];
          },
          label: function(context) {
            // Extract just the percentage and hours part
            var label = context.label || '';
            var match = label.match(/\(([^)]+)\)/);
            return match ? match[1] : label;
          }
        };
      }
      
      console.log('Creating chart with config:', config);
      teamChart = new Chart(chartElement, config);
      console.log('Chart created successfully');
      
    } catch (error) {
      console.error('Error creating chart:', error);
    }
  }

  // Toggle between detailed and summary views for activity analysis
  function toggleActivityView() {
    var detailedView = document.getElementById('team-activity-detailed-view');
    var summaryView = document.getElementById('team-activity-summary-view');
    var toggleText = document.getElementById('view-toggle-text');
    
    if (!detailedView || !summaryView || !toggleText) {
      return;
    }
    
    var newViewState;
    if (detailedView.style.display === 'none') {
      // Currently showing summary, switch to detailed
      detailedView.style.display = 'block';
      summaryView.style.display = 'none';
      toggleText.textContent = 'Show Summary View';
      localStorage.setItem('team_activity_view_mode', 'detailed');
      newViewState = 'detailed';
      updatePaginationInfo('detailed');
    } else {
      // Currently showing detailed, switch to summary
      detailedView.style.display = 'none';
      summaryView.style.display = 'block';
      toggleText.textContent = 'Show Detailed View';
      localStorage.setItem('team_activity_view_mode', 'summary');
      newViewState = 'summary';
      updatePaginationInfo('summary');
    }
    
    // Regenerate chart with new view state
    regenerateChartForViewState(newViewState);
  }

  // Update pagination info text based on view state
  function updatePaginationInfo(viewState) {
    var paginationInfo = document.getElementById('pagination-info-text');
    if (!paginationInfo) {
      return;
    }
    
    var detailedText = paginationInfo.getAttribute('data-detailed-text');
    var viewMode = paginationInfo.getAttribute('data-view-mode');
    
    if (viewState === 'detailed') {
      // Show detailed view pagination (based on time periods)
      paginationInfo.textContent = detailedText;
    } else {
      // Show summary view pagination (based on activities)
      var count;
      if (viewMode === 'activity') {
        count = parseInt(paginationInfo.getAttribute('data-activity-count')) || 0;
      }
      
      // Format: "Showing 1 to X of X entries"
      paginationInfo.textContent = 'Showing 1 to ' + count + ' of ' + count + ' entries';
    }
  }

  // Regenerate chart based on activity view state (summary vs detailed)
  function regenerateChartForViewState(viewState) {
    // Get current URL parameters
    var urlParams = new URLSearchParams(window.location.search);
    
    // Add/update activity_view_state parameter
    urlParams.set('activity_view_state', viewState);
    
    // Build new URL
    var baseUrl = window.location.pathname;
    var newUrl = baseUrl + '?' + urlParams.toString();
    
    // Reload page with new view state parameter
    window.location.href = newUrl;
  }

  // Restore activity view preference
  function restoreActivityViewState() {
    var savedMode = localStorage.getItem('team_activity_view_mode');
    var detailedView = document.getElementById('team-activity-detailed-view');
    var summaryView = document.getElementById('team-activity-summary-view');
    var toggleText = document.getElementById('view-toggle-text');
    
    if (!detailedView || !summaryView || !toggleText) {
      return;
    }
    
    // Default to detailed view if no saved preference
    var currentMode = savedMode || 'detailed';
    
    if (currentMode === 'summary') {
      detailedView.style.display = 'none';
      summaryView.style.display = 'block';
      toggleText.textContent = 'Show Detailed View';
      updatePaginationInfo('summary');
    } else {
      // Default to detailed view
      detailedView.style.display = 'block';
      summaryView.style.display = 'none';
      toggleText.textContent = 'Show Summary View';
      updatePaginationInfo('detailed');
    }
    
    // Update hidden field with current state
    var hiddenField = document.getElementById('activity_view_state_field');
    if (hiddenField) {
      hiddenField.value = currentMode;
    }
  }

  // Toggle between detailed and summary views for project analysis
  function toggleProjectView() {
    var detailedView = document.getElementById('team-project-detailed-view');
    var summaryView = document.getElementById('team-project-summary-view');
    var toggleText = document.getElementById('project-view-toggle-text');
    
    if (!detailedView || !summaryView || !toggleText) {
      return;
    }
    
    var newViewState;
    if (detailedView.style.display === 'none') {
      // Currently showing summary, switch to detailed
      detailedView.style.display = 'block';
      summaryView.style.display = 'none';
      toggleText.textContent = 'Show Summary View';
      localStorage.setItem('team_project_view_mode', 'detailed');
      newViewState = 'detailed';
      updateProjectPaginationInfo('detailed');
    } else {
      // Currently showing detailed, switch to summary
      detailedView.style.display = 'none';
      summaryView.style.display = 'block';
      toggleText.textContent = 'Show Detailed View';
      localStorage.setItem('team_project_view_mode', 'summary');
      newViewState = 'summary';
      updateProjectPaginationInfo('summary');
    }
    
    // Regenerate chart with new view state
    regenerateChartForProjectViewState(newViewState);
  }

  // Update pagination info for project view
  function updateProjectPaginationInfo(viewState) {
    var paginationInfo = document.getElementById('pagination-info-text');
    if (!paginationInfo) {
      return;
    }
    
    var detailedText = paginationInfo.getAttribute('data-detailed-text');
    var viewMode = paginationInfo.getAttribute('data-view-mode');
    
    if (viewState === 'detailed') {
      // Show detailed view pagination (based on time periods)
      paginationInfo.textContent = detailedText;
    } else {
      // Show summary view pagination (based on projects)
      var count;
      if (viewMode === 'project') {
        count = parseInt(paginationInfo.getAttribute('data-project-count')) || 0;
      }
      
      // Format: "Showing 1 to X of X entries"
      paginationInfo.textContent = 'Showing 1 to ' + count + ' of ' + count + ' entries';
    }
  }

  // Regenerate chart based on project view state (summary vs detailed)
  function regenerateChartForProjectViewState(viewState) {
    // Get current URL parameters
    var urlParams = new URLSearchParams(window.location.search);
    
    // Add/update project_view_state parameter
    urlParams.set('project_view_state', viewState);
    
    // Build new URL
    var baseUrl = window.location.pathname;
    var newUrl = baseUrl + '?' + urlParams.toString();
    
    // Reload page with new view state parameter
    window.location.href = newUrl;
  }

  // Restore project view preference
  function restoreProjectViewState() {
    var savedMode = localStorage.getItem('team_project_view_mode');
    var detailedView = document.getElementById('team-project-detailed-view');
    var summaryView = document.getElementById('team-project-summary-view');
    var toggleText = document.getElementById('project-view-toggle-text');
    
    if (!detailedView || !summaryView || !toggleText) {
      return;
    }
    
    // Default to detailed view if no saved preference
    var currentMode = savedMode || 'detailed';
    
    if (currentMode === 'summary') {
      detailedView.style.display = 'none';
      summaryView.style.display = 'block';
      toggleText.textContent = 'Show Detailed View';
      updateProjectPaginationInfo('summary');
    } else {
      // Default to detailed view
      detailedView.style.display = 'block';
      summaryView.style.display = 'none';
      toggleText.textContent = 'Show Summary View';
      updateProjectPaginationInfo('detailed');
    }
    
    // Update hidden field with current state
    var hiddenField = document.getElementById('project_view_state_field');
    if (hiddenField) {
      hiddenField.value = currentMode;
    }
  }

  // Toggle member view between detailed and summary
  function toggleMemberView() {
    var detailedView = document.getElementById('team-member-detailed-view');
    var summaryView = document.getElementById('team-member-summary-view');
    var toggleText = document.getElementById('member-view-toggle-text');
    
    if (!detailedView || !summaryView || !toggleText) {
      return;
    }
    
    var newViewState;
    if (detailedView.style.display === 'none') {
      // Currently showing summary, switch to detailed
      detailedView.style.display = 'block';
      summaryView.style.display = 'none';
      toggleText.textContent = 'Show Summary View';
      localStorage.setItem('team_member_view_mode', 'detailed');
      newViewState = 'detailed';
      updateMemberPaginationInfo('detailed');
    } else {
      // Currently showing detailed, switch to summary
      detailedView.style.display = 'none';
      summaryView.style.display = 'block';
      toggleText.textContent = 'Show Detailed View';
      localStorage.setItem('team_member_view_mode', 'summary');
      newViewState = 'summary';
      updateMemberPaginationInfo('summary');
    }
    
    // Regenerate chart with new view state
    regenerateChartForMemberViewState(newViewState);
  }

  // Update pagination info for member view
  function updateMemberPaginationInfo(viewState) {
    var paginationInfo = document.getElementById('pagination-info-text');
    if (!paginationInfo) {
      return;
    }
    
    var detailedText = paginationInfo.getAttribute('data-detailed-text');
    var viewMode = paginationInfo.getAttribute('data-view-mode');
    
    if (viewState === 'detailed') {
      // Show detailed view pagination (based on time periods)
      paginationInfo.textContent = detailedText;
    } else {
      // Show summary view pagination (based on members)
      var count = parseInt(paginationInfo.getAttribute('data-member-count'));
      paginationInfo.textContent = 'Showing 1 to ' + count + ' of ' + count + ' members';
    }
  }

  // Regenerate chart when member view state changes
  function regenerateChartForMemberViewState(viewState) {
    // Get current URL parameters
    var urlParams = new URLSearchParams(window.location.search);
    
    // Add/update member_view_state parameter
    urlParams.set('member_view_state', viewState);
    
    // Build new URL
    var baseUrl = window.location.pathname;
    var newUrl = baseUrl + '?' + urlParams.toString();
    
    // Reload page with new view state parameter
    window.location.href = newUrl;
  }

  // Restore member view preference
  function restoreMemberViewState() {
    var savedMode = localStorage.getItem('team_member_view_mode');
    var detailedView = document.getElementById('team-member-detailed-view');
    var summaryView = document.getElementById('team-member-summary-view');
    var toggleText = document.getElementById('member-view-toggle-text');
    
    if (!detailedView || !summaryView || !toggleText) {
      return;
    }
    
    // Default to detailed view if no saved preference
    var currentMode = savedMode || 'detailed';
    
    if (currentMode === 'summary') {
      detailedView.style.display = 'none';
      summaryView.style.display = 'block';
      toggleText.textContent = 'Show Detailed View';
      updateMemberPaginationInfo('summary');
    } else {
      // Default to detailed view
      detailedView.style.display = 'block';
      summaryView.style.display = 'none';
      toggleText.textContent = 'Show Summary View';
      updateMemberPaginationInfo('detailed');
    }
    
    // Update hidden field with current state
    var hiddenField = document.getElementById('member_view_state_field');
    if (hiddenField) {
      hiddenField.value = currentMode;
    }
  }

  // Table sorting function for summary views
  function sortTable(header, columnIndex, tableContainerId) {
    var container = document.getElementById(tableContainerId);
    var table = container.querySelector('table');
    var tbody = table.querySelector('tbody');
    var rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Determine current sort direction
    var currentSort = header.getAttribute('data-sort') || 'none';
    var newSort = currentSort === 'asc' ? 'desc' : 'asc';
    
    // Remove sort indicators from all headers
    var allHeaders = table.querySelectorAll('th.sortable');
    allHeaders.forEach(function(th) {
      th.setAttribute('data-sort', 'none');
      var indicator = th.querySelector('.sort-indicator');
      if (indicator) indicator.textContent = '⇅';
    });
    
    // Sort rows
    rows.sort(function(a, b) {
      var aCell = a.cells[columnIndex];
      var bCell = b.cells[columnIndex];
      
      // Get numeric value from data-value attribute
      var aVal = parseFloat(aCell.getAttribute('data-value') || aCell.textContent);
      var bVal = parseFloat(bCell.getAttribute('data-value') || bCell.textContent);
      
      if (newSort === 'asc') {
        return aVal - bVal;
      } else {
        return bVal - aVal;
      }
    });
    
    // Reappend sorted rows
    rows.forEach(function(row) {
      tbody.appendChild(row);
    });
    
    // Update sort indicator
    header.setAttribute('data-sort', newSort);
    var indicator = header.querySelector('.sort-indicator');
    if (indicator) {
      indicator.textContent = newSort === 'asc' ? '▲' : '▼';
    }
  }
</script>

<style>
  .sortable {
    cursor: pointer;
    user-select: none;
  }
  .sortable:hover {
    background-color: #e8e8e8;
  }
  .sort-indicator {
    font-size: 0.8em;
    margin-left: 5px;
    color: #999;
  }
  
  /* View toggle controls styling */
  .view-toggle-controls {
    display: inline-block;
    margin-left: 15px;
  }
</style>
