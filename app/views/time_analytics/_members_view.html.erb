<!-- Members View - Show team member contribution analysis -->
<div class="box">
  <h3>
    Members Analysis
    <div class="view-toggle-controls">
      <button type="button" id="toggle-member-view-btn" class="button button-base button-primary" onclick="toggleMemberView()">
        <span id="member-view-toggle-text">Show Summary View</span>
      </button>
    </div>
    <div class="table-controls">
      <%= form_tag time_analytics_team_dashboard_path, method: :get, local: true, 
          class: 'pagination-form' do %>
        <%= hidden_field_tag :filter, params[:filter] %>
        <%= hidden_field_tag :from, params[:from] %>
        <%= hidden_field_tag :to, params[:to] %>
        <%= hidden_field_tag :grouping, params[:grouping] %>
        <%= hidden_field_tag :search, params[:search] %>
        <%= hidden_field_tag :chart_type, params[:chart_type] %>
        <%= hidden_field_tag :team_id, params[:team_id] %>
        <%= hidden_field_tag :view_mode, @view_mode %>
        <%= label_tag :per_page, l(:label_per_page) %>
        <%= select_tag :per_page, options_for_select(per_page_options, @limit),
            onchange: 'this.form.submit()' %>
      <% end %>
    </div>
  </h3>

  <% has_data = @paginated_periods&.any? %>
  
  <% if has_data %>
    <% if ['weekly', 'monthly', 'yearly'].include?(@grouping) %>
      <%# Detailed View: Pivot Table (Time Period × Member matrix) - Default %>
      <div id="member-detailed-view" class="pivot-table-wrapper">
        <table class="list pivot-table">
          <thead>
            <tr>
              <th class="period-header"><%= l("label_#{@grouping}") %></th>
              <% @members.each do |member| %>
                <th class="activity-header"><%= member %></th>
              <% end %>
              <th class="total-header">Grand Total</th>
            </tr>
          </thead>
          <tbody>
            <% @paginated_periods.each_with_index do |period_display, index| %>
              <% period_key = @member_pivot_data[:raw_periods][(@offset + index)] %>
              <tr>
                <td class="period-cell"><%= period_display %></td>
                <% @members.each do |member| %>
                  <td class="hours-cell">
                    <% hours = @matrix_data[period_key][member] || 0 %>
                    <%= hours > 0 ? format_hours(hours) : '' %>
                  </td>
                <% end %>
                <td class="total-cell">
                  <%= format_hours(@period_totals[period_key] || 0) %>
                </td>
              </tr>
            <% end %>
          </tbody>
          <tfoot>
            <tr class="total-row">
              <td class="period-cell"><strong>Grand Total</strong></td>
              <% @members.each do |member| %>
                <td class="total-cell">
                  <strong><%= format_hours(@member_totals[member] || 0) %></strong>
                </td>
              <% end %>
              <td class="grand-total-cell">
                <strong><%= format_hours(@grand_total || 0) %></strong>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
      
      <%# Summary View: Simple Member Table (Hidden by default) %>
      <div id="member-summary-view" style="display: none;">
        <table class="list time-entries-grouped-table summary-with-bars">
          <thead>
            <tr>
              <th>Member</th>
              <th class="hours-column sortable" onclick="sortTable(this, 1, 'member-summary-view')" title="Click to sort">
                Total Hours <span class="sort-indicator">⇅</span>
              </th>
              <th class="bar-column">Distribution</th>
            </tr>
          </thead>
          <tbody>
            <% @members.each do |member| %>
              <% hours = @member_totals[member] || 0 %>
              <% percentage = @grand_total > 0 ? (hours / @grand_total * 100) : 0 %>
              <tr>
                <td><%= member %></td>
                <td class="hours-column" data-value="<%= hours %>"><%= format_hours(hours) %></td>
                <td class="bar-column">
                  <div class="bar-container">
                    <div class="bar-fill" style="width: <%= percentage %>%"></div>
                    <span class="bar-label"><%= number_with_precision(percentage, precision: 1) %>%</span>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
          <tfoot>
            <tr class="total-row">
              <td><strong><%= l(:label_total) %></strong></td>
              <td class="hours-column"><strong><%= format_hours(@grand_total || 0) %></strong></td>
              <td class="bar-column"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    <% elsif @grouping == 'daily' %>
      <%# Daily Member Analysis - Dual View System %>
      
      <%# Detailed View: Daily Pivot Table (Date × Member matrix) - Default %>
      <div id="member-detailed-view" class="pivot-table-wrapper">
        <table class="list pivot-table">
          <thead>
            <tr>
              <th class="period-header">Date</th>
              <% @members.each do |member| %>
                <th class="activity-header"><%= member %></th>
              <% end %>
              <th class="total-header">Daily Total</th>
            </tr>
          </thead>
          <tbody>
            <% @paginated_periods.each_with_index do |period_display, index| %>
              <% period_key = @member_pivot_data[:raw_periods][(@offset + index)] %>
              <tr>
                <td class="period-cell"><%= period_display %></td>
                <% @members.each do |member| %>
                  <td class="hours-cell">
                    <% hours = @matrix_data[period_key][member] || 0 %>
                    <%= hours > 0 ? format_hours(hours) : '' %>
                  </td>
                <% end %>
                <td class="total-cell">
                  <%= format_hours(@period_totals[period_key] || 0) %>
                </td>
              </tr>
            <% end %>
          </tbody>
          <tfoot>
            <tr class="total-row">
              <td class="period-cell"><strong>Grand Total</strong></td>
              <% @members.each do |member| %>
                <td class="total-cell">
                  <strong><%= format_hours(@member_totals[member] || 0) %></strong>
                </td>
              <% end %>
              <td class="grand-total-cell">
                <strong><%= format_hours(@grand_total || 0) %></strong>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
      
      <%# Summary View: Simple Member Table (Hidden by default) %>
      <div id="member-summary-view" style="display: none;">
        <table class="list time-entries-grouped-table summary-with-bars">
          <thead>
            <tr>
              <th>Member</th>
              <th class="hours-column sortable" onclick="sortTable(this, 1, 'member-summary-view')" title="Click to sort">
                Total Hours <span class="sort-indicator">⇅</span>
              </th>
              <th class="bar-column">Distribution</th>
            </tr>
          </thead>
          <tbody>
            <% if @paginated_entries %>
              <% @paginated_entries.each do |entry| %>
                <% percentage = @total_hours > 0 ? (entry.hours / @total_hours * 100) : 0 %>
                <tr>
                  <td><%= entry.period %></td>
                  <td class="hours-column" data-value="<%= entry.hours %>"><%= format_hours(entry.hours) %></td>
                  <td class="bar-column">
                    <div class="bar-container">
                      <div class="bar-fill" style="width: <%= percentage %>%"></div>
                      <span class="bar-label"><%= number_with_precision(percentage, precision: 1) %>%</span>
                    </div>
                  </td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
          <tfoot>
            <tr class="total-row">
              <td><strong><%= l(:label_total) %></strong></td>
              <td class="hours-column"><strong><%= format_hours(@total_hours) %></strong></td>
              <td class="bar-column"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    <% end %>
    
    <!-- Pagination -->
    <div class="pagination-wrapper">
      <% current_page = params[:page].to_i > 0 ? params[:page].to_i : 1 %>
      <% permitted_params = params.permit(:filter, :from, :to, :grouping, :search, :chart_type, :per_page, :view_mode, :team_id) %>
      <%= pagination_links(current_page, @total_pages, permitted_params).html_safe %>
      
      <div class="pagination-info">
        <%= l(:text_pagination_info, 
            from: (@offset + 1), 
            to: [@offset + @limit, @entry_count].min, 
            total: @entry_count) %>
      </div>
    </div>
  <% else %>
    <p class="nodata"><%= l(:label_no_data) %></p>
  <% end %>
</div>

<script>
function toggleMemberView() {
  const detailedView = document.getElementById('member-detailed-view');
  const summaryView = document.getElementById('member-summary-view');
  const toggleText = document.getElementById('member-view-toggle-text');
  const memberViewState = document.getElementById('member-view-state');
  
  if (summaryView.style.display === 'none') {
    // Switch to summary view
    detailedView.style.display = 'none';
    summaryView.style.display = 'block';
    toggleText.textContent = 'Show Detailed View';
    if (memberViewState) memberViewState.value = 'summary';
    
    // Update chart to show member-based grouping
    updateChart('<%= params[:chart_type] || 'pie' %>', 'summary');
  } else {
    // Switch to detailed view
    detailedView.style.display = 'block';
    summaryView.style.display = 'none';
    toggleText.textContent = 'Show Summary View';
    if (memberViewState) memberViewState.value = 'detailed';
    
    // Update chart to show time period-based grouping
    updateChart('<%= params[:chart_type] || 'pie' %>', 'detailed');
  }
}
</script>
